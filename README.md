# Quant Service

KOSPI/KOSDAQ 전종목을 대상으로 데이터를 수집하고, 6가지 투자 전략으로 스크리닝하며, Claude AI 정성 분석 보고서를 생성하는 한국 주식 퀀트 서비스입니다.

## 목차

- [아키텍처 개요](#아키텍처-개요)
- [디렉터리 구조](#디렉터리-구조)
- [설치](#설치)
- [환경 변수](#환경-변수)
- [실행](#실행)
- [데이터 흐름](#데이터-흐름)
- [모듈 상세](#모듈-상세)
  - [데이터 수집 (quant_collector_enhanced.py)](#데이터-수집-quant_collector_enhancedpy)
  - [스크리닝 엔진 (quant_screener.py)](#스크리닝-엔진-quant_screenerpy)
  - [데이터베이스 (db.py)](#데이터베이스-dbpy)
  - [파이프라인 (pipeline.py)](#파이프라인-pipelinepy)
  - [웹 서버 (webapp/app.py)](#웹-서버-webappapppy)
  - [AI 분석 (analysis/claude_analyzer.py)](#ai-분석-analysisclaude_analyzerpy)
  - [배치 스케줄러 (batch/scheduler.py)](#배치-스케줄러-batchschedulerpy)
- [스크리닝 전략](#스크리닝-전략)
- [스코어링 시스템](#스코어링-시스템)
- [REST API](#rest-api)
- [데이터베이스 스키마](#데이터베이스-스키마)
- [주요 구현 패턴](#주요-구현-패턴)
- [개발 가이드](#개발-가이드)

---

## 아키텍처 개요

```
[데이터 소스]                    [파이프라인]                [출력]
  FnGuide (크롤링) ──┐
  FinanceDataReader ──┼──► quant_collector ──► DuckDB ──► quant_screener ──► Excel (7종)
  KRX (pykrx)    ──┘          │                              │
                              └──────────────────────────────┤
                                                             ▼
                                                      dashboard_result
                                                             │
                                                      webapp/app.py (Flask)
                                                             │
                                                      Claude API (AI 분석)
```

- **데이터 수집**: FnGuide HTML 크롤링 + FinanceDataReader API
- **저장소**: DuckDB 단일 파일(`data/quant.duckdb`), `collected_date`로 버전 관리
- **스크리닝**: 퍼센타일 기반 스코어링 + 전략별 필터
- **웹 인터페이스**: Flask REST API + 대시보드 UI
- **AI 보고서**: Claude API (5대 투자 대가 프레임워크)

---

## 디렉터리 구조

```
Quant-service/
├── run.py                        # 메인 진입점 (CLI)
├── pipeline.py                   # 파이프라인 오케스트레이터
├── quant_collector_enhanced.py   # 데이터 수집기
├── quant_screener.py             # 스크리닝 엔진 (v8)
├── db.py                         # DuckDB 헬퍼
├── config.py                     # 설정 (환경변수 로드)
├── requirements.txt
├── .env.example
├── batch/
│   ├── __init__.py
│   └── scheduler.py              # APScheduler 배치 스케줄러
├── analysis/
│   ├── __init__.py
│   └── claude_analyzer.py        # Claude AI 정성 분석
├── webapp/
│   ├── __init__.py
│   ├── app.py                    # Flask 앱 + REST API
│   ├── templates/
│   │   └── dashboard.html        # 대시보드 UI
│   └── static/                   # CSS, JS
└── data/                         # 런타임 생성 (gitignore)
    ├── quant.duckdb              # 메인 DB
    ├── reports/                  # AI 분석 보고서 캐시
    └── *.xlsx                    # 스크리닝 결과 엑셀
```

---

## 설치

```bash
# Python 3.11+ 권장
pip install -r requirements.txt
```

**주요 의존성**

| 패키지 | 용도 |
|--------|------|
| `flask`, `flask-cors` | 웹 서버 |
| `duckdb` | 데이터베이스 |
| `pandas`, `numpy` | 데이터 처리 |
| `FinanceDataReader` | 주가/상장정보 수집 |
| `pykrx` | KRX 데이터 |
| `anthropic` | Claude AI API |
| `apscheduler` | 배치 스케줄러 |
| `gunicorn` | 프로덕션 서버 |
| `openpyxl`, `lxml` | 엑셀/HTML 파싱 |

---

## 환경 변수

`.env.example`을 참고하여 환경변수를 설정하세요.

| 변수 | 기본값 | 설명 |
|------|--------|------|
| `BATCH_HOUR` | `18` | 일일 배치 실행 시간 (KST, 0-23) |
| `BATCH_MINUTE` | `0` | 배치 실행 분 (0-59) |
| `HOST` | `0.0.0.0` | 웹 서버 바인드 호스트 |
| `PORT` | `5000` | 웹 서버 포트 |
| `DEBUG` | `false` | Flask 디버그 모드 |
| `ANTHROPIC_API_KEY` | *(없음)* | Claude AI 분석용 (선택) |
| `ANALYSIS_MODEL` | `claude-sonnet-4-5-20250929` | 분석에 사용할 Claude 모델 |

---

## 실행

### CLI 명령어

```bash
# 웹 서버 시작 (배치 스케줄러 포함)
python run.py server

# 전체 파이프라인 실행 (수집 + 스크리닝)
python run.py pipeline

# 테스트 모드 (삼성전자·카카오·SK하이닉스 3종목만)
python run.py pipeline --test

# 수집 건너뛰고 스크리닝만 재실행
python run.py pipeline --skip-collect

# 데이터 수집만 실행
python run.py collect

# 스크리닝만 실행 (DB에 데이터 있어야 함)
python run.py screen
```

### 프로덕션 서버

```bash
gunicorn -w 4 -b 0.0.0.0:5000 webapp.app:app
```

---

## 데이터 흐름

```
1. collect_master()     → KRX 전종목 마스터 (FinanceDataReader)
2. collect_daily()      → 일별 시세 + 시가총액 (FinanceDataReader)
3. fetch_fs()           → 재무제표 IS/BS/CF (FnGuide 크롤링, 병렬)
4. fetch_indicators()   → Financial Highlight + 재무비율 + DPS (FnGuide)
5. fetch_shares()       → 발행주식수, 자사주, 유통주식수 (FnGuide)
6. collect_price_history() → 52주 주가/거래량 히스토리 (FinanceDataReader)
         │
         ▼ (DB 저장: collected_date 기준 버전 관리)
7. preprocess_indicators() → 중복 제거
8. detect_unit_multiplier() → 삼성전자 매출로 단위 추론 (억/백만 등)
9. analyze_all()        → 종목별 펀더멘털 분석 (TTM, CAGR, F-Score, 배당 등)
10. calc_valuation()    → PER/PBR/ROE/S-RIM/PSR/PEG/FCF수익률 등 계산
11. calc_technical_indicators() → 52주 고저, MA이격도, RSI, 거래대금, 변동성
12. save_dashboard()    → dashboard_result 테이블 저장
13. save_to_excel()     → 전략별 7개 엑셀 파일 출력
```

---

## 모듈 상세

### 데이터 수집 (`quant_collector_enhanced.py`)

FnGuide와 FinanceDataReader를 통해 KOSPI/KOSDAQ 전종목 데이터를 수집합니다.

**수집 항목**

| 단계 | 함수 | 소스 | 수집 내용 |
|------|------|------|-----------|
| 1 | `collect_master()` | FinanceDataReader | 종목코드, 종목명, 시장구분, 종목구분(보통주/우선주/스팩/리츠) |
| 2 | `collect_daily()` | FinanceDataReader | 종가, 시가총액, 상장주식수 |
| 3 | `fetch_fs()` | FnGuide | IS/BS/CF 재무제표 (연간·분기, 실적+추정치) |
| 4 | `fetch_indicators()` | FnGuide | Financial Highlight, 재무비율, 주당배당금(DPS) |
| 5 | `fetch_shares()` | FnGuide | 발행주식수, 자사주, 유통주식수 |
| 6 | `collect_price_history()` | FinanceDataReader | 52주 OHLCV + 거래대금 |

**병렬 처리**

- `ThreadPoolExecutor(max_workers=15)` 로 FnGuide 크롤링을 병렬 수행
- 이미 DB에 해당 `collected_date`의 데이터가 있으면 수집을 건너뜀 (이어하기 지원)

**인코딩 처리**

FnGuide HTML 응답을 `cp949 → euc-kr → utf-8` 순으로 시도하여 한글 깨짐을 방지합니다.

---

### 스크리닝 엔진 (`quant_screener.py`)

v8 버전. 펀더멘털 분석, 밸류에이션 계산, 기술적 지표, 6가지 스크리닝 전략을 담당합니다.

#### 핵심 함수

| 함수 | 설명 |
|------|------|
| `detect_unit_multiplier(ind_df)` | 삼성전자(005930) 매출 규모로 재무 데이터 단위 추론 |
| `analyze_one_stock()` | 종목 1개 펀더멘털 분석 (TTM, CAGR, F-Score, 배당 등) |
| `analyze_all()` | 전체 종목 루프 처리 |
| `calc_valuation()` | PER/PBR/ROE/PSR/PEG/FCF수익률/S-RIM 등 계산 |
| `calc_technical_indicators()` | 52주 고저·이격도·RSI·거래대금·변동성 계산 |
| `apply_screen()` | 우량주/저평가 스크리닝 |
| `apply_momentum_screen()` | 모멘텀/성장주 스크리닝 |
| `apply_garp_screen()` | GARP (Growth At Reasonable Price) |
| `apply_cashcow_screen()` | 캐시카우 (버핏 스타일) |
| `apply_turnaround_screen()` | 턴어라운드 (역발상) |
| `apply_dividend_growth_screen()` | 배당 성장주 |

#### TTM (Trailing 12 Months) 계산 방식

분기 데이터(RATIO_Q)에서 최근 4분기 합계를 우선 사용하고, 없으면 연간 데이터(RATIO_Y)의 최신값으로 대체합니다.

#### 계절성 통제 지표 (v8 추가)

분기별 전년동기비(YoY) 성장률을 계산하여 계절성 영향을 제거합니다.

- `Q_매출_YoY(%)` / `Q_영업이익_YoY(%)` / `Q_순이익_YoY(%)`: 최근 분기 YoY
- `Q_*_연속YoY성장`: 연속으로 YoY 플러스인 분기 수
- `TTM_*_YoY(%)`: 최근 4분기 합 vs 전년 4분기 합 비교

#### Piotroski F-Score (9개 항목)

| 항목 | 조건 |
|------|------|
| F1 수익성 | 순이익(TTM) > 0 |
| F2 영업CF | 영업현금흐름 > 0 |
| F3 ROA 개선 | 순이익/자산총계 전년 대비 증가 |
| F4 이익 품질 | 영업CF > 순이익 (발생주의 회계 왜곡 없음) |
| F5 레버리지 감소 | 부채비율(부채/자본) 전년 대비 하락 |
| F6 유동성 개선 | 유동비율(유동자산/유동부채) 전년 대비 상승 |
| F7 희석 없음 | 발행주식수 미증가 |
| F8 매출총이익률 개선 | 매출총이익/매출액 전년 대비 상승 |
| F9 자산회전율 개선 | 매출/자산총계 전년 대비 상승 |

#### S-RIM 적정주가

```
ROE > Ke(8%)인 경우: BPS + BPS × (ROE - Ke) / Ke
ROE ≤ Ke인 경우:    BPS × 0.9

괴리율(%) = (적정주가 - 현재가) / 현재가 × 100
```

---

### 데이터베이스 (`db.py`)

DuckDB 단일 파일(`data/quant.duckdb`)로 모든 데이터를 관리합니다.

#### 테이블 목록

| 테이블 | PK | 내용 |
|--------|----|------|
| `master` | 종목코드, collected_date | 종목 마스터 (시장구분, 종목구분) |
| `daily` | 종목코드, collected_date | 일별 시세 (종가, 시가총액, EPS, BPS, DPS) |
| `financial_statements` | - | 재무제표 세로형 (계정, 기준일, 주기, 값) |
| `indicators` | - | 핵심 지표 (지표구분, 계정, 기준일, 값) |
| `shares` | 종목코드, collected_date | 발행주식수, 자사주, 유통주식수 |
| `price_history` | 종목코드, 날짜, collected_date | OHLCV + 거래대금 |
| `dashboard_result` | 종목코드 | 스크리닝 결과 전체 (60+ 컬럼) |
| `dashboard_result_prev` | - | 직전 배치 결과 (변동 비교용) |
| `analysis_reports` | 종목코드 | Claude AI 보고서 (HTML + JSON) |

#### 버전 관리

`collected_date` 컬럼으로 날짜별 데이터를 관리합니다. `load_latest(table)`은 항상 `MAX(collected_date)` 데이터를 반환하며, 같은 날 재실행 시 기존 데이터를 덮어씁니다.

#### 주요 함수

```python
init_db()                          # 스키마 초기화
save_df(df, table, collected_date) # DataFrame → 테이블 저장
load_latest(table)                 # 최신 데이터 로드
save_dashboard(df)                 # dashboard_result 갱신 (prev 자동 백업)
save_report(code, name, html, ...) # AI 보고서 저장
load_report(code)                  # AI 보고서 조회
get_data_status()                  # 테이블별 데이터 현황
```

---

### 파이프라인 (`pipeline.py`)

수집 → 스크리닝 → 저장을 순서대로 실행하는 오케스트레이터입니다.

```python
run_pipeline(skip_collect=False, test_mode=False)
```

실행 순서:
1. `quant_collector_enhanced.run_full()` — 데이터 수집
2. DB에서 6개 테이블 로드
3. 전처리 및 단위 추론
4. 펀더멘털 분석 (`analyze_all`)
5. 밸류에이션 계산 (`calc_valuation`)
6. 기술적 지표 계산 (`calc_technical_indicators`)
7. master 테이블에서 시장/종목구분 병합
8. `dashboard_result` DB 저장
9. 전략별 7개 엑셀 파일 저장

---

### 웹 서버 (`webapp/app.py`)

Flask 기반 REST API와 대시보드 UI를 제공합니다.

**인메모리 캐시**: DB 파일의 `mtime`이 바뀔 때만 재로드하여 성능을 최적화합니다.

**스크리닝 일관성 주의**: `_apply_screen_filter()` 함수는 `quant_screener.py`의 스크리닝 로직을 동일하게 구현해야 합니다. **스크리닝 조건 변경 시 두 파일을 반드시 함께 수정하세요.**

---

### AI 분석 (`analysis/claude_analyzer.py`)

Claude API를 사용하여 5대 투자 대가 관점의 정성 분석 보고서를 생성합니다.

**5대 투자 대가 프레임워크**

| 대가 | 철학 | 가중치 |
|------|------|--------|
| Warren Buffett | 경제적 해자 & 안전마진 | 25% |
| Aswath Damodaran | 내재가치 & 내러티브 | 20% |
| Philip Fisher | 성장 잠재력 & 경영 품질 | 20% |
| Pat Dorsey | 경제적 해자 심층 분석 | 20% |
| André Kostolany | 시장 심리 & 역발상 | 15% |

**입력 데이터**: 밸류에이션, 수익성, 성장성, 재무건전성, 배당, 기술적 지표, TTM 실적 (8개 섹션)

**출력**: 대가별 점수(1-10), 종합 점수(1-100), 투자 등급(A+~D), 리스크/촉매, HTML 보고서

`ANTHROPIC_API_KEY` 환경변수가 없으면 AI 분석 기능이 비활성화됩니다.

---

### 배치 스케줄러 (`batch/scheduler.py`)

APScheduler를 사용하여 매일 장 마감 후 자동으로 파이프라인을 실행합니다.

```python
start_scheduler()   # 백그라운드 스케줄러 시작
stop_scheduler()    # 스케줄러 종료
```

기본값: 매일 18:00 KST (`BATCH_HOUR=18, BATCH_MINUTE=0`)

웹 서버 실행 시 자동으로 시작되며, UI에서 수동 트리거도 가능합니다(`POST /api/batch/trigger`).

---

## 스크리닝 전략

총 6가지 전략으로 종목을 분류합니다.

### ① 우량주/저평가 (`apply_screen`)

장기 보유용 우량 저평가 종목.

| 조건 | 기준 |
|------|------|
| 흑자 | TTM 순이익 > 0 |
| ROE | ≥ 5% |
| PER | 1 ~ 50 |
| PBR | 0.1 ~ 10 |
| 매출 연속성장 | ≥ 2년 |
| 순이익 연속성장 | ≥ 1년 |
| 시가총액 | ≥ 500억 |
| F-Score | ≥ 5 |

### ② 모멘텀/성장주 (`apply_momentum_screen`)

빠른 성장과 마진 개선 중인 종목. 분기 YoY 지표로 계절성 통제.

| 조건 | 기준 |
|------|------|
| 매출 또는 영업이익 CAGR | ≥ 15% (OR 조건) |
| 이익률 개선 | 전년 대비 영업이익률 상승 |
| ROE | ≥ 5% |
| 흑자 | TTM 순이익 > 0 |
| 시가총액 | ≥ 500억 |

**모멘텀 점수** = 매출CAGR×2 + 영업이익CAGR×2.5 + ROE×1.5 + Q_매출YoY×2 + Q_영업이익YoY×2 + RSI×1 + ...

### ③ GARP (`apply_garp_screen`)

피터 린치 스타일 — 성장주를 합리적 가격에.

| 조건 | 기준 |
|------|------|
| PEG | 0 ~ 1.5 |
| 매출 CAGR | ≥ 10% |
| ROE | ≥ 12% |
| PER | 5 ~ 30 |
| 시가총액 | ≥ 500억 |

### ④ 캐시카우 (`apply_cashcow_screen`)

버핏 스타일 — 높은 현금흐름 + 저부채.

| 조건 | 기준 |
|------|------|
| ROE | ≥ 10% |
| 영업이익률 | ≥ 10% |
| 부채비율 | < 100% |
| 이익 품질 | 영업CF > 순이익 |
| F-Score | ≥ 6 |
| 매출 연속성장 | ≥ 1년 |
| 시가총액 | ≥ 500억 |

### ⑤ 턴어라운드 (`apply_turnaround_screen`)

역발상 — 실적 반등 초기 발굴.

| 조건 | 기준 |
|------|------|
| 흑자전환 OR 이익률 급개선 | 적자→흑자 전환 또는 영업이익률 +5%p 이상 |
| 현재 흑자 | TTM 순이익 > 0 |
| 시가총액 | ≥ 300억 (소형주 포함) |

### ⑥ 배당 성장주 (`apply_dividend_growth_screen`)

수익과 배당이 함께 증가하는 기업.

| 조건 | 기준 |
|------|------|
| 순이익 연속성장 | ≥ 2년 |
| 배당금 연속증가 | ≥ 1년 |
| DPS CAGR | > 0% |
| 배당수익률 | > 0% |
| ROE | ≥ 5% |
| 수익+배당 동반증가 | ✓ |
| 시가총액 | ≥ 300억 |

---

## 스코어링 시스템

모든 지표는 **퍼센타일 기반(0~100)** 으로 정규화한 후 가중합산합니다.

```
종합점수 =
  S_PER × 1.5  +  S_PBR × 1.0  +  S_ROE × 2.0  +
  S_매출CAGR × 2.0  +  S_영업이익CAGR × 2.0  +  S_순이익CAGR × 1.0  +
  S_연속성장 × 1.0  +  S_이익률개선 × 1.0  +
  S_배당수익률 × 0.3  +  S_배당연속증가 × 0.3  +
  S_괴리율 × 1.0  +  S_F스코어 × 2.0  +  S_FCF수익률 × 1.5
```

각 전략별로 별도의 점수(`모멘텀_점수`, `GARP_점수`, `캐시카우_점수`, `턴어라운드_점수`, `배당성장_점수`)도 계산합니다.

---

## REST API

| 메서드 | 엔드포인트 | 설명 |
|--------|-----------|------|
| `GET` | `/` | 대시보드 UI |
| `GET` | `/api/stocks` | 종목 목록 (페이지네이션, 필터, 정렬) |
| `GET` | `/api/stocks/<code>` | 종목 상세 정보 |
| `GET` | `/api/stocks/<code>/financials` | 연간 재무제표 시계열 (차트용) |
| `GET` | `/api/markets/summary` | KOSPI/KOSDAQ 시장 요약 통계 |
| `POST` | `/api/batch/trigger` | 파이프라인 수동 트리거 |
| `GET` | `/api/batch/status` | 파이프라인 실행 상태 |
| `GET` | `/api/batch/changes` | 전략별 종목 편입/제거 변동 |
| `GET` | `/api/reports` | AI 분석 보고서 목록 |
| `GET` | `/api/reports/<code>` | AI 보고서 조회 |
| `POST` | `/api/reports/<code>` | AI 보고서 생성 (Claude API 호출) |
| `DELETE` | `/api/reports/<code>` | AI 보고서 삭제 |
| `GET` | `/api/status` | DB 데이터 현황 |

### `/api/stocks` 쿼리 파라미터

| 파라미터 | 설명 | 예시 |
|----------|------|------|
| `screen` | 전략 필터 | `all`, `screened`, `momentum`, `garp`, `cashcow`, `turnaround`, `dividend_growth` |
| `market` | 시장 필터 | `KOSPI`, `KOSDAQ` |
| `q` | 종목명/코드 검색 | `삼성` |
| `sort` | 정렬 컬럼 | `종합점수` |
| `order` | 정렬 방향 | `asc`, `desc` |
| `page` | 페이지 번호 (1부터) | `1` |
| `size` | 페이지 크기 (최대 200) | `50` |
| `codes` | 관심종목 코드 목록 | `005930,000660` |
| `min_PER` | PER 최솟값 필터 | `5` |
| `max_PER` | PER 최댓값 필터 | `20` |

---

## 데이터베이스 스키마

### financial_statements

재무제표를 세로형(long format)으로 저장합니다.

| 컬럼 | 타입 | 설명 |
|------|------|------|
| 종목코드 | TEXT | 6자리 제로패딩 |
| 기준일 | TEXT | YYYY-MM-DD |
| 계정 | TEXT | 매출액, 영업이익, 당기순이익 등 |
| 주기 | TEXT | `y`=연간, `q`=분기 |
| 값 | DOUBLE | 재무 수치 |
| 추정치 | INTEGER | 0=실적, 1=추정(E) |
| collected_date | TEXT | 수집 날짜 |

### indicators

Financial Highlight와 재무비율 데이터.

| 지표구분 | 설명 |
|----------|------|
| `HIGHLIGHT` | FnGuide 메인 Financial Highlight |
| `RATIO_Y` | 연간 재무비율 |
| `RATIO_Q` | 분기 재무비율 |
| `DPS` | 주당배당금 |

---

## 주요 구현 패턴

### 종목코드 형식

항상 6자리 제로패딩을 사용합니다.

```python
code = str(x).zfill(6)   # "5930" → "005930"
```

### 단위 추론

삼성전자(005930) 매출액 규모를 기준으로 재무 데이터의 단위 배수를 자동 감지합니다.

```python
latest_rev > 1e14  →  multiplier = 1          # 원 단위
latest_rev > 1e8   →  multiplier = 1_000_000  # 백만원 단위
else               →  multiplier = 100_000_000 # 억원 단위
```

### 스크리닝 일관성 유지 (중요)

스크리닝 필터 로직은 두 곳에 존재합니다:

1. `quant_screener.py` — `apply_*_screen()` 함수
2. `webapp/app.py` — `_apply_screen_filter()` 함수

**스크리닝 조건을 변경할 때 반드시 두 파일을 동시에 수정해야 합니다.**

### dashboard_result 백업

`save_dashboard()` 호출 시 기존 `dashboard_result` 테이블을 `dashboard_result_prev`로 자동 백업하여 전 배치 결과와 비교(`/api/batch/changes`)할 수 있습니다.

---

## 개발 가이드

### 새 스크리닝 전략 추가

1. `quant_screener.py`에 `apply_new_screen(df)` 함수 추가
2. `pipeline.py`에서 해당 함수를 호출하고 엑셀 저장
3. `webapp/app.py`의 `_apply_screen_filter()`에 새 전략 조건 추가
4. `/api/stocks`의 `screen` 파라미터 처리에 새 전략명 추가

### 새 지표 추가

1. `quant_screener.py`의 `analyze_one_stock()` 또는 `calc_valuation()`에 계산 로직 추가
2. `db.py`의 `dashboard_result` 스키마에 컬럼 추가
3. `webapp/app.py`의 `DISPLAY_COLS` 리스트에 컬럼명 추가
4. (선택) `analysis/claude_analyzer.py`의 `QUANT_SECTIONS`에 AI 분석 입력으로 추가

### 테스트 모드

3개 샘플 종목(삼성전자·카카오·SK하이닉스)으로 전체 파이프라인을 빠르게 검증합니다.

```bash
python run.py pipeline --test
```

`TEST_TICKERS = ["005930", "035720", "000660"]` (`quant_collector_enhanced.py`)
