# 워치리스트 종목 비교 기능 구현 계획

## 개요
워치리스트에 있는 종목들을 선택하여 나란히(side-by-side) 비교할 수 있는 기능을 추가합니다.
핵심 지표를 테이블과 차트로 비교하여 투자 의사결정을 지원합니다.

---

## 1단계: 백엔드 API 추가 (`webapp/app.py`)

### 새 엔드포인트: `GET /api/stocks/compare`

- **파라미터**: `codes=005930,000660,035720` (콤마 구분, 2~8개)
- **응답 구조**:
  ```json
  {
    "stocks": [
      { "종목코드": "005930", "종목명": "삼성전자", "PER": 12.3, ... },
      { "종목코드": "000660", "종목명": "SK하이닉스", "PER": 8.5, ... }
    ],
    "financials": {
      "005930": { "years": ["2020","2021",...], "series": [...] },
      "000660": { "years": [...], "series": [...] }
    },
    "metrics_meta": {
      "PER": { "best": "low", "label": "PER" },
      "ROE(%)": { "best": "high", "label": "ROE%" },
      ...
    }
  }
  ```
- `metrics_meta`에 각 지표의 높을수록/낮을수록 좋은지 정보를 포함하여 프론트엔드에서 best/worst 하이라이팅에 활용
- 기존 `_load_data()`, `_row_to_dict()`, `_safe_val()` 재활용
- 기존 `api_stock_financials` 로직 재활용하여 여러 종목의 재무 데이터 한 번에 반환

---

## 2단계: 프론트엔드 UI 흐름 (`dashboard.js`)

### A. 워치리스트 탭에 비교 모드 진입 UI 추가
- 워치리스트 탭 활성화 시 **"비교하기"** 버튼 표시
- 버튼 클릭 시 비교 모드 활성화: 테이블 행에 체크박스 표시
- 선택된 종목 수 실시간 표시 (예: "3/8 선택됨")
- **"비교 시작"** 버튼 → 비교 모달 오픈
- 최소 2개, 최대 8개 선택 제한

### B. 비교 테이블 행에 체크박스 추가
- 비교 모드 시 ★ 열 옆에 체크박스 컬럼 추가
- 체크박스 상태는 JS `Set`으로 관리 (`compareSelection`)
- 페이지 전환/정렬 시에도 선택 상태 유지

---

## 3단계: 비교 모달 UI (`dashboard.html` + `dashboard.js`)

### A. 모달 구조 (`#compare-modal`)
```
┌─────────────────────────────────────────────────────┐
│  종목 비교  (삼성전자, SK하이닉스, LG에너지솔루션)        │
├─────────────────────────────────────────────────────┤
│  [밸류에이션] [성장성] [수익성] [재무건전성] [기술적]    │ ← 카테고리 탭
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─ 비교 테이블 (종목이 열, 지표가 행) ──────────┐     │
│  │ 지표        삼성전자    SK하이닉스   LG에너지  │     │
│  │ PER         12.3★      8.5★★       45.2     │     │ ← best 하이라이트
│  │ PBR         1.82       1.45★       3.21     │     │
│  │ ROE%        15.3★      18.2★★      8.5      │     │
│  │ ...                                          │     │
│  └──────────────────────────────────────────────┘     │
│                                                     │
│  ┌─ 레이더 차트 ────────────────────────────────┐     │
│  │    (Chart.js Radar: 주요 지표 5~8개)          │     │
│  │    PER, PBR, ROE, 성장률, F-Score 등           │     │
│  │    각 종목을 다른 색상 라인으로 표시             │     │
│  └──────────────────────────────────────────────┘     │
│                                                     │
│  ┌─ 재무 추이 비교 차트 ─────────────────────────┐     │
│  │    [매출액] [영업이익] [순이익] ← 토글 버튼       │     │
│  │    (Chart.js Line: 각 종목의 5개년 추이)        │     │
│  └──────────────────────────────────────────────┘     │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                      [Close]         │
└─────────────────────────────────────────────────────┘
```

### B. 비교 테이블 카테고리별 지표 그룹
1. **밸류에이션**: PER, PBR, PSR, PEG, 적정주가_SRIM, 괴리율(%)
2. **성장성**: 매출_CAGR, 영업이익_CAGR, 순이익_CAGR, 매출_연속성장, Q_매출_YoY(%), Q_영업이익_YoY(%)
3. **수익성**: ROE(%), 영업이익률(%), FCF수익률(%), 이익수익률(%), 배당수익률(%), 현금전환율(%)
4. **재무건전성**: F스코어, 부채비율(%), 부채상환능력, 이익품질_양호, CAPEX비율(%)
5. **기술적 지표**: 52주_최고대비(%), 52주_최저대비(%), RSI_14, MA20_이격도(%), 변동성_60일(%)

### C. Best/Worst 하이라이팅 로직
- `metrics_meta`의 `best` 필드 활용
- `best: "high"` → 행에서 가장 높은 값 초록색 배경
- `best: "low"` → 행에서 가장 낮은 값 초록색 배경
- 최악 값은 연한 빨간색 배경

### D. 레이더 차트 (Chart.js Radar)
- 비교 지표 (0-100 정규화): PER(역수), ROE, 영업이익률, 매출_CAGR, F스코어, FCF수익률, 괴리율(역수)
- 각 종목을 다른 색상 라인/영역으로 표시
- 비교 대상 전체에서 min-max 정규화

### E. 재무 추이 비교 차트 (Chart.js Line)
- `/api/stocks/compare` 응답의 `financials` 데이터 활용
- 매출액/영업이익/순이익 토글 버튼
- 각 종목을 다른 색상 라인으로 표시
- 연도별 추이를 한눈에 비교

---

## 4단계: CSS 스타일 추가 (`webapp/static/css/style.css`)

- `.compare-table`: 전치 테이블 (지표=행, 종목=열) 스타일
- `.best-val`: 최고값 하이라이트 (연한 초록 배경)
- `.worst-val`: 최악값 하이라이트 (연한 빨간 배경)
- `.compare-checkbox`: 비교 모드 체크박스 스타일
- `.compare-bar`: 비교 모드 하단 고정 바
- `.category-tab`: 카테고리 탭 스타일
- 반응형 처리 (모바일에서는 가로 스크롤)

---

## 수정 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `webapp/app.py` | `/api/stocks/compare` 엔드포인트 추가 |
| `webapp/templates/dashboard.html` | 비교 모달 HTML, 비교 버튼 추가 |
| `webapp/static/js/dashboard.js` | 비교 모드 로직, 비교 모달 렌더링, 차트 생성 |
| `webapp/static/css/style.css` | 비교 관련 스타일 추가 |

---

## 기술적 고려사항

1. **기존 코드와의 일관성**: Vanilla JS + Bootstrap 5 + Chart.js 패턴 유지
2. **성능**: 비교 API에서 한 번의 호출로 모든 데이터(지표 + 재무제표) 반환
3. **사용성**: 워치리스트 탭에서만 비교 모드 접근 가능 (자연스러운 흐름)
4. **확장성**: 카테고리별 지표 그룹은 상수로 관리하여 추후 수정 용이
5. **데이터 저장**: 비교 선택 상태는 세션 내 메모리에만 유지 (localStorage 불필요)
