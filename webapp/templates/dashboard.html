<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quant Dashboard - KOSPI / KOSDAQ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/style.css" rel="stylesheet">
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Quant Dashboard</a>
    <div class="d-flex align-items-center gap-2">
      <button id="btn-refresh" class="btn btn-outline-light btn-sm">Refresh</button>
      <button id="btn-trigger" class="btn btn-warning btn-sm d-flex align-items-center gap-1">
        <span id="btn-trigger-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
        <span id="btn-trigger-label">Run Pipeline</span>
      </button>
    </div>
  </div>
</nav>

<div class="container-fluid mt-3">

  <!-- Market summary -->
  <div class="row mb-3" id="market-summary"></div>

  <!-- Screening tabs -->
  <ul class="nav nav-tabs mb-0" id="screen-tabs">
    <li class="nav-item">
      <a class="nav-link active" href="#" data-screen="all">
        All Stocks <span class="badge bg-secondary ms-1" id="cnt-all"></span>
        <span class="badge badge-change ms-1" id="chg-all" style="display:none;"></span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-screen="screened">
        Quality <span class="badge bg-success ms-1" id="cnt-screened"></span>
        <span class="badge badge-change ms-1" id="chg-screened" style="display:none;"></span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-screen="momentum">
        Momentum <span class="badge bg-primary ms-1" id="cnt-momentum"></span>
        <span class="badge badge-change ms-1" id="chg-momentum" style="display:none;"></span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-screen="garp">
        GARP <span class="badge bg-info ms-1" id="cnt-garp"></span>
        <span class="badge badge-change ms-1" id="chg-garp" style="display:none;"></span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-screen="cashcow">
        Cashcow <span class="badge bg-warning text-dark ms-1" id="cnt-cashcow"></span>
        <span class="badge badge-change ms-1" id="chg-cashcow" style="display:none;"></span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-screen="turnaround">
        Turnaround <span class="badge bg-danger ms-1" id="cnt-turnaround"></span>
        <span class="badge badge-change ms-1" id="chg-turnaround" style="display:none;"></span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-screen="dividend_growth">
        Dividend Growth <span class="badge bg-success ms-1" id="cnt-dividend_growth"></span>
        <span class="badge badge-change ms-1" id="chg-dividend_growth" style="display:none;"></span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="#" data-screen="watchlist">
        ★ Watchlist <span class="badge bg-warning text-dark ms-1" id="cnt-watchlist">0</span>
      </a>
    </li>
  </ul>

  <!-- Compare bar (watchlist only) -->
  <div id="compare-bar" class="compare-bar" style="display:none;">
    <div class="d-flex align-items-center gap-2">
      <button id="btn-compare-mode" class="btn btn-outline-info btn-sm">비교하기</button>
      <span id="compare-count" class="text-muted small" style="display:none;">0개 선택</span>
      <button id="btn-compare-start" class="btn btn-info btn-sm" style="display:none;" disabled>비교 시작</button>
      <button id="btn-compare-cancel" class="btn btn-outline-secondary btn-sm" style="display:none;">취소</button>
    </div>
  </div>

  <!-- Strategy description -->
  <div id="strategy-desc" class="alert alert-light mb-3 py-2 px-3 border-start-0 border-end-0 border-bottom rounded-0" style="font-size: 0.9rem; line-height: 1.6;">
  </div>

  <!-- Batch changes banner -->
  <div id="change-banner" class="change-banner mb-2" style="display:none;"></div>

  <!-- Filters -->
  <div class="card border-top-0 rounded-top-0 mb-3">
    <div class="card-body py-2">
      <form id="filter-form" class="row g-2 align-items-end">
        <div class="col-auto">
          <label class="form-label mb-0 small">Market</label>
          <select id="f-market" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="KOSPI">KOSPI</option>
            <option value="KOSDAQ">KOSDAQ</option>
          </select>
        </div>
        <div class="col-auto">
          <label class="form-label mb-0 small">Search</label>
          <input id="f-search" class="form-control form-control-sm" placeholder="Name or code">
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-primary btn-sm">Filter</button>
          <button type="button" id="btn-clear" class="btn btn-outline-secondary btn-sm">Clear</button>
          <button type="button" id="btn-adv-filter" class="btn btn-outline-info btn-sm">Advanced ▼</button>
        </div>
        <div class="col-auto ms-auto d-flex align-items-end gap-1">
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="btn-load-preset" data-bs-toggle="dropdown" aria-expanded="false">
              Presets
            </button>
            <ul class="dropdown-menu dropdown-menu-end" id="preset-dropdown">
              <li><span class="dropdown-item text-muted small">No saved presets</span></li>
            </ul>
          </div>
          <button type="button" id="btn-save-preset" class="btn btn-outline-success btn-sm" title="Save current filters as preset">Save</button>
        </div>
      </form>
    </div>

    <!-- Advanced Column Filters (initially hidden) -->
    <div id="adv-filter-panel" class="card-body py-2 border-top" style="display: none; background: #f9f9f9;">
      <div class="row g-2" id="column-filters"></div>
    </div>
  </div>

  <!-- Save Preset Modal -->
  <div class="modal fade" id="preset-save-modal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header py-2">
          <h6 class="modal-title">Filter Preset Save</h6>
          <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label small mb-1">Preset Name</label>
            <input type="text" id="preset-name-input" class="form-control form-control-sm" placeholder="e.g. ROE>15 & PER<12">
          </div>
          <div id="preset-save-summary" class="small text-muted mb-2"></div>
        </div>
        <div class="modal-footer py-1">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="btn-confirm-save-preset" class="btn btn-success btn-sm">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data table -->
  <div class="table-responsive">
    <table id="stock-table" class="table table-striped table-hover table-sm w-100">
      <thead class="table-dark">
        <tr id="table-header"></tr>
      </thead>
      <tbody id="stock-tbody"></tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between align-items-center mt-2 mb-4">
    <span id="page-info" class="text-muted small"></span>
    <div>
      <button id="btn-prev" class="btn btn-sm btn-outline-primary" disabled>&laquo; Prev</button>
      <button id="btn-next" class="btn btn-sm btn-outline-primary">Next &raquo;</button>
    </div>
  </div>

  <!-- Detail modal -->
  <div class="modal fade" id="detail-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detail-title">Stock Detail</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detail-body">
          <div class="metric-grid" id="detail-metrics"></div>
          <div id="financial-chart-area" class="mt-3" style="display:none;">
            <div class="text-muted small fw-semibold mb-1">재무 추이 (연간)</div>
            <div style="height:200px; position:relative;">
              <canvas id="financial-chart"></canvas>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="btn-watch-detail" class="btn btn-outline-warning btn-sm" data-code="">☆ 관심 종목</button>
          <button type="button" id="btn-analysis" class="btn btn-outline-primary btn-sm" data-code="">
            AI 정성 분석
          </button>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Compare modal -->
  <div class="modal fade" id="compare-modal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="compare-title">종목 비교</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="compare-body">
          <!-- Category tabs -->
          <ul class="nav nav-pills nav-fill mb-3" id="compare-category-tabs">
            <li class="nav-item"><a class="nav-link active" href="#" data-cat="valuation">밸류에이션</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-cat="growth">성장성</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-cat="profitability">수익성</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-cat="health">재무건전성</a></li>
            <li class="nav-item"><a class="nav-link" href="#" data-cat="technical">기술적</a></li>
          </ul>

          <!-- Compare table -->
          <div class="table-responsive mb-4">
            <table class="table table-bordered table-sm compare-table" id="compare-table">
              <thead id="compare-thead"></thead>
              <tbody id="compare-tbody"></tbody>
            </table>
          </div>

          <!-- Radar chart -->
          <div class="mb-4">
            <h6 class="text-muted small fw-semibold mb-2">종합 비교 (레이더 차트)</h6>
            <div style="max-width:500px; margin:0 auto; position:relative;">
              <canvas id="compare-radar-chart"></canvas>
            </div>
          </div>

          <!-- Financial trend chart -->
          <div class="mb-3">
            <div class="d-flex align-items-center gap-2 mb-2">
              <h6 class="text-muted small fw-semibold mb-0">재무 추이 비교</h6>
              <div class="btn-group btn-group-sm" id="compare-fin-toggle">
                <button class="btn btn-outline-primary btn-sm active" data-acc="매출액">매출액</button>
                <button class="btn btn-outline-primary btn-sm" data-acc="영업이익">영업이익</button>
                <button class="btn btn-outline-primary btn-sm" data-acc="당기순이익">순이익</button>
              </div>
            </div>
            <div style="height:250px; position:relative;">
              <canvas id="compare-fin-chart"></canvas>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Analysis Report modal -->
  <div class="modal fade" id="report-modal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="report-title">AI 정성 분석 보고서</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="report-body">
          <div class="text-center py-5" id="report-loading" style="display:none;">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <div class="text-muted">Claude가 분석 보고서를 생성하고 있습니다...</div>
            <div class="text-muted small mt-1">약 15-30초 소요됩니다</div>
          </div>
          <div id="report-content"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="btn-regenerate" class="btn btn-outline-warning btn-sm" data-code="" style="display:none;">
            보고서 재생성
          </button>
          <span id="report-meta" class="text-muted small me-auto"></span>
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
  <div id="toast-msg" class="toast" role="alert">
    <div class="toast-header">
      <strong class="me-auto">Pipeline</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
    </div>
    <div class="toast-body" id="toast-body"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/dashboard.js"></script>
</body>
</html>
